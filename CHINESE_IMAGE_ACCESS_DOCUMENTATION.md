# Image Access Authorization Documentation for Chinese Manufacturing Partners

This document explains how to properly access design images from our PimpMyCase system with the correct authorization tokens.

## Overview

All design images hosted on `https://pimpmycase.onrender.com/image/` require proper authentication tokens to access. The system uses time-based, partner-specific tokens to secure image access.

## Token System

### Token Structure
```
https://pimpmycase.onrender.com/image/[filename]?token=[timestamp]:[partner_type]:[signature]
```

### Partner Types
- `end_user` - 1 hour expiry (for customer preview)
- `chinese_manufacturing` - 48 hours expiry (for manufacturing partners)

## Accessing Images

### Successful Access Example
```
GET https://pimpmycase.onrender.com/image/order-session_1756378358-final-1756378358-e5f1af36.png?token=1756551196:chinese_manufacturing:c1791efad696b1bc60d45a2852731e897332e43716cb75b5db750694f6414105
```

### Failed Access (Missing Token)
```
GET https://pimpmycase.onrender.com/image/order-session_1756378358-final-1756378358-e5f1af36.png
Response: 422 Unprocessable Entity
Error: [{'type': 'missing', 'loc': ('query', 'token'), 'msg': 'Field required', 'input': None}]
```

## Integration with Order Data API

When receiving order data from our system via the `/api/chinese/order/orderData` endpoint, the image URL (`pic` field) will already include the proper token:

### Example Order Data Response
```json
{
  "third_pay_id": "PYEN250828378395",
  "third_id": "OREN250828378396", 
  "mobile_model_id": "MM102503290004",
  "pic": "https://pimpmycase.onrender.com/image/order-session_1756378358-final-1756378358-e5f1af36.png?token=1756551196:chinese_manufacturing:c1791efad696b1bc60d45a2852731e897332e43716cb75b5db750694f6414105",
  "device_id": "CXYLOGD8OQUK",
  "mobile_shell_id": "MS102503290010"
}
```

## Token Validation

### Valid Token Response
```
HTTP/1.1 200 OK
Content-Type: image/png
[Image data]
```

### Invalid/Expired Token Response  
```
HTTP/1.1 422 Unprocessable Entity
Content-Type: application/json
{
  "detail": [
    {
      "type": "missing",
      "loc": ["query", "token"],
      "msg": "Field required",
      "input": None
    }
  ]
}
```

## Token Expiry

### Chinese Manufacturing Tokens
- **Expiry**: 48 hours from generation
- **Purpose**: Allow sufficient time for manufacturing processes
- **Automatic generation**: Our system generates these automatically when sending order data

### End User Tokens  
- **Expiry**: 1 hour from generation
- **Purpose**: Customer preview only
- **Not suitable**: For manufacturing processes due to short expiry

## Troubleshooting Common Issues

### Issue 1: 422 Unprocessable Entity with "Field required" error
**Cause**: Accessing image URL without token parameter
**Solution**: Always use the complete URL including the token parameter as provided in order data

### Issue 2: Token expired
**Cause**: Attempting to access image after token expiry (48 hours)
**Solution**: Contact our system to regenerate token or re-request order data

### Issue 3: Invalid signature  
**Cause**: Token signature has been modified or corrupted
**Solution**: Use exact URL as provided, do not modify token components

## Important Notes

1. **Do NOT remove tokens**: Always preserve the complete URL including token parameter
2. **Do NOT cache without tokens**: Store the complete authenticated URL, not just the filename
3. **Token lifespan**: Chinese manufacturing tokens are valid for 48 hours
4. **No manual token generation**: Tokens are automatically generated by our system
5. **One-time use**: Each order gets a unique token, do not reuse tokens across orders

## Contact Information

For technical issues with image access:
- **API Support**: Contact PimpMyCase technical team
- **Integration Issues**: Provide order ID and specific error messages

## Implementation Checklist

- [ ] Always use complete URLs with tokens as provided in order data
- [ ] Implement proper error handling for 422 responses  
- [ ] Store authenticated URLs, not just filenames
- [ ] Verify token inclusion before image access attempts
- [ ] Set up monitoring for token expiry issues

## Example Integration Code

### Correct Image Access
```python
import requests

def download_design_image(order_data):
    image_url = order_data['pic']  # Use complete URL with token
    
    if not image_url or '?token=' not in image_url:
        raise ValueError("Invalid image URL - missing token")
    
    response = requests.get(image_url)
    
    if response.status_code == 200:
        return response.content
    elif response.status_code == 422:
        raise Exception("Token missing or invalid")
    else:
        raise Exception(f"Image access failed: {response.status_code}")
```

### Incorrect Image Access
```python
# DON'T DO THIS - Missing token
image_url = "https://pimpmycase.onrender.com/image/filename.png"
response = requests.get(image_url)  # Will fail with 422 error
```

---

*This documentation is provided to ensure smooth integration between PimpMyCase and Chinese manufacturing partners. Please follow these guidelines to avoid image access issues.*